const WORKFLOW_BY_SERVICE: Record<string, string[]> = {
  "전문 공인노무사 상담": [
    "초기 상담 접수 및 이슈 진단",
    "핵심 쟁점·리스크 구조화",
    "실행 가능한 대응 시나리오 제시",
    "후속 진행(대리·자문) 범위 확정",
  ],
  "임금체불 진정사건 대리": [
    "체불 항목·기간·금액 확정",
    "증빙자료 정리 및 진정 전략 수립",
    "노동청 진정 절차 대리 진행",
    "결정 결과 후속 집행 지원",
  ],
  "대지급금 신청 대리": [
    "수급 요건(도산·지급불능) 사전 진단",
    "필수 증빙·신청서류 구성",
    "대지급금 신청 대리 진행",
    "보완요청 대응 및 결과 안내",
  ],
  "퇴직금 청구 대리": [
    "근속기간·평균임금 산정 검토",
    "퇴직금 미지급 금액 확정",
    "청구 절차(진정/소송 연계) 진행",
    "수령 단계까지 후속 관리",
  ],
  "임금명세서 위반 대응": [
    "명세서 교부 이력 및 누락 항목 확인",
    "위반 유형별 법적 쟁점 정리",
    "시정요구·행정대응 절차 진행",
    "재발 방지 문서체계 정비",
  ],
  "최저임금 위반 대응": [
    "임금구성항목 및 시급 환산 검토",
    "최저임금 미달 구간·금액 산출",
    "시정·청구 절차 진행",
    "정산 및 재발 방지안 정리",
  ],
  "연장·야간·휴일수당 청구": [
    "근로시간 데이터 및 근무기록 확보",
    "가산수당 산정 기준 확정",
    "수당 청구·진정 절차 진행",
    "지급 결과 및 후속 대응",
  ],
  "연차휴가 미사용수당 청구": [
    "연차 발생·사용·소멸 이력 검토",
    "미사용수당 대상 일수·금액 확정",
    "청구 절차 진행 및 대응",
    "지급 완료 후 정산 검토",
  ],
  "근로시간 위반 진단": [
    "근무표·출퇴근기록 수집",
    "법정 근로·휴게 기준 대비 분석",
    "위반 리스크 및 개선안 도출",
    "운영기준 재정비안 제시",
  ],
  "포괄임금제 적법성 점검": [
    "포괄임금 약정·운영 실태 파악",
    "적법성·무효 가능성 검토",
    "임금 재산정 및 분쟁 리스크 분석",
    "개선 계약안·운영안 제시",
  ],
  "통상임금 재산정 자문": [
    "임금항목별 통상임금 포함 여부 검토",
    "재산정 금액·파급효과 분석",
    "분쟁·소급 리스크 대응안 수립",
    "임금체계 보완안 확정",
  ],
  "부당해고 구제신청 대리": [
    "해고 사유·절차 적법성 검토",
    "증빙·주장 구조화 및 서면 준비",
    "노동위원회 구제신청 대리 진행",
    "심문·결정 후속 조치",
  ],
  "부당징계 구제신청 대리": [
    "징계사유·양정·절차 검토",
    "징계 무효 주장 포인트 정리",
    "구제신청·심문 대응 대리",
    "결정 이후 복귀·정산 지원",
  ],
  "부당전직·전보 대응": [
    "발령 사유·업무상 필요성 검토",
    "불이익 여부 및 위법성 판단",
    "이의제기·구제절차 진행",
    "원상회복·조건조정 협의",
  ],
  "권고사직·사직강요 대응": [
    "퇴사 권유 과정 및 증거 확보",
    "자발성·강요성 판단 포인트 정리",
    "대응 전략(유지/합의/구제) 확정",
    "협상·절차 후속 지원",
  ],
  "직장 내 괴롭힘 신고 대응": [
    "사건 타임라인·행위 유형 정리",
    "증거 확보 및 신고 문서 작성",
    "사내 조사·조치 절차 대응",
    "후속 보호조치·외부절차 연계",
  ],
  "직장 내 성희롱 대응": [
    "피해 사실·행위 유형 정리",
    "증거·진술 확보 및 신고 설계",
    "사내 조사·징계 절차 대응",
    "재발방지·추가 구제 절차 연계",
  ],
  "산재보상 신청 대리": [
    "사고·질병 발생 경위 확인",
    "업무관련성 입증자료 구성",
    "산재급여 신청 절차 대리",
    "결정 통지 후 보완·이의 대응",
  ],
  "업무상질병 산재 인정 대응": [
    "질병 진단·업무이력 분석",
    "노출·과로·인과관계 자료 정리",
    "업무상질병 인정 신청 진행",
    "보완요구·불승인 대응",
  ],
  "장해급여 청구 지원": [
    "치료종결 및 장해 상태 확인",
    "장해등급 판단자료 구성",
    "장해급여 청구 진행",
    "등급 결과 이의·보완 대응",
  ],
  "유족급여·장의비 청구 지원": [
    "사망 경위·업무관련성 자료 수집",
    "유족 범위·청구권 검토",
    "유족급여·장의비 청구 진행",
    "결정 이후 후속 권리 안내",
  ],
  "실업급여 이직확인서 대응": [
    "이직 사유·확인서 기재 검토",
    "정정 필요 항목 및 근거 정리",
    "정정 요청·행정 절차 진행",
    "수급 안정화 후속 지원",
  ],
  "부정수급 조사 대응": [
    "조사 통지 내용·쟁점 파악",
    "소명자료 수집·반박 논리 정리",
    "조사·의견진술 절차 대응",
    "환수·제재 후속 대응",
  ],

  "사업주·인사담당 노무자문": [
    "현안 이슈 접수 및 사실관계 정리",
    "법적 쟁점·위험도 레벨 진단",
    "의사결정 옵션별 리스크 비교",
    "실행안·커뮤니케이션 문안 확정",
  ],
  "취업규칙 제·개정 자문": [
    "현행 취업규칙·운영 실태 진단",
    "개정 필요 조항 설계 및 문안 작성",
    "불이익변경 절차(의견청취·동의) 이행",
    "신고·시행 및 분쟁예방 점검",
  ],
  "근로계약서 점검·작성": [
    "직무·고용형태별 필수 조항 정의",
    "현행 계약서 위법·누락 조항 점검",
    "표준 템플릿 및 특약 문구 설계",
    "체결·변경·보관 운영체계 확정",
  ],
  "인사규정 정비 자문": [
    "규정 체계·조항 충돌 여부 진단",
    "채용·평가·징계·퇴직 기준 재정렬",
    "개정 문안 확정 및 시행 절차 진행",
    "운영 매뉴얼 배포·담당자 교육",
  ],
  "교대제·근무표 설계 자문": [
    "현행 교대패턴·인력운영 데이터 진단",
    "법정 근로시간·휴게·가산수당 영향 분석",
    "교대조 편성안·근무표 시뮬레이션 설계",
    "시범운영 후 확정안·운영 가이드 배포",
  ],
  "임금체계 개편 자문": [
    "현행 임금구조·수당 체계 진단",
    "개편 목표(공정성·유연성·통제성) 확정",
    "직무/성과/역할 기반 보상안 설계",
    "전환 시뮬레이션·노사 커뮤니케이션 실행",
  ],
  "성과급·인센티브 설계 자문": [
    "보상 목적·대상·예산 범위 설정",
    "KPI·평가연동 산식 및 지급기준 설계",
    "차별·임금성·분쟁 리스크 점검",
    "운영지침 공지 및 시범운영 착수",
  ],
  "인사평가 제도 설계": [
    "평가 목적·직군별 프레임 정렬",
    "평가항목·척도·보정기준 설계",
    "공정성 장치·이의절차 반영",
    "파일럿 운영 후 본도입 확정",
  ],
  "징계위원회 운영 자문": [
    "사건 접수 및 조사 범위 확정",
    "징계사유·증거·양정기준 검토",
    "징계위 개최·의결 절차 운영",
    "통지·재심·사후관리 문서화",
  ],
  "노동청 근로감독 대응": [
    "감독 쟁점별 사전 리스크 점검",
    "요구자료 패키지·설명논리 준비",
    "현장감독 질의응답·소명 대응",
    "시정명령 이행 및 재점검 관리",
  ],
  "노동관계 법정의무 컴플라이언스 점검": [
    "법정의무 항목별 준수 현황 진단",
    "위반·미흡 항목 우선순위 분류",
    "시정계획·책임부서·기한 확정",
    "정기 모니터링 체계 구축",
  ],
  "4대보험 취득·상실 정정 자문": [
    "취득·상실·보수신고 이력 정합성 점검",
    "오류 유형·원인·영향 범위 분석",
    "정정 신고·소명 자료 제출",
    "재발 방지 체크포인트 정착",
  ],
  "노사협의회 설치·운영 자문": [
    "설치 의무·대표 구성 적정성 확인",
    "운영규정·회의 프로토콜 설계",
    "정기회의 안건 설계·진행 지원",
    "회의록·합의사항 이행 관리",
  ],
  "고충처리제도 구축": [
    "고충 유형 분류·처리 기준 확정",
    "접수·조사·조치 SLA 설계",
    "담당자 권한·보고 라인 설정",
    "운영지표 모니터링 체계 구축",
  ],
  "단체교섭 전략 자문": [
    "교섭 의제·핵심 쟁점 사전 분석",
    "최초안·양보안·결렬대응 시나리오 설계",
    "교섭 진행·문서·회의 대응 지원",
    "합의서 정리 및 이행관리",
  ],
  "단체협약 검토 자문": [
    "현행 협약 조항 법적 리스크 진단",
    "운영상 충돌·해석 분쟁 조항 정비",
    "개정안·협상 포인트 도출",
    "체결 후 적용·분쟁 모니터링",
  ],
  "노동쟁의 대응 자문": [
    "쟁의 단계별 법적 리스크 진단",
    "합법 대응 가이드·비상운영안 수립",
    "현장 운영·대외 커뮤니케이션 대응",
    "분쟁 완화·정상화 로드맵 실행",
  ],
  "부당노동행위 구제신청 지원": [
    "행위 유형·노조활동 관련성 검토",
    "증빙자료·소명논리 구조화",
    "구제신청·심문 절차 대응",
    "판정 후 시정조치·재발방지 관리",
  ],
  "비정규직 차별시정 대응": [
    "차별 판단 기준·비교대상 확정",
    "임금·복리후생 격차 분석",
    "시정신청·협의 절차 대응",
    "제도 보완 및 재발방지 정착",
  ],
  "파견·도급 적법성 진단": [
    "업무지휘·지시 체계 실태 조사",
    "파견/도급 법적 판단 및 갭 분석",
    "불법파견 리스크 대응 시나리오 설계",
    "계약구조·운영모델 개선 실행",
  ],
  "원·하청 노무리스크 점검": [
    "원·하청 역할·책임 분장 진단",
    "현장 인력운영 리스크 식별",
    "계약·관리체계 개선안 수립",
    "정기 점검·감사 체계 정례화",
  ],
  "직장폐쇄·쟁의 국면 대응": [
    "쟁의 상황 및 법적 쟁점 분석",
    "직장폐쇄 요건·시기·절차 검토",
    "운영연속성·대응 시나리오 실행",
    "사후 분쟁 정리·관계 회복 지원",
  ],
  "기업 인사노무 실사(DD)": [
    "실사 범위 정의·데이터룸 구성",
    "채용·임금·노사 리스크 정밀 분석",
    "핵심 이슈·잠재부채 보고서 작성",
    "거래조건 반영·시정계획 제안",
  ],
  "HR Due Diligence 보고서 작성": [
    "리스크 항목 프레임·평가기준 설계",
    "문서·인터뷰 기반 사실확인",
    "리스크 등급화·재무영향 분석",
    "개선 권고안 포함 최종 보고",
  ],
  "사내 교육(노동법·인사실무)": [
    "교육 대상·직군별 니즈 진단",
    "사례 중심 커리큘럼 설계",
    "오프라인/온라인 교육 및 Q&A",
    "사후 매뉴얼·실무 가이드 배포",
  ],
  "직장 내 괴롭힘 예방체계 구축": [
    "예방규정·판단기준 정비",
    "신고·조사·조치 프로토콜 구축",
    "관리자·구성원 예방교육 실행",
    "운영 점검·사후 개선 루프 운영",
  ],
  "직장 내 성희롱 예방체계 구축": [
    "예방·대응 규정 및 지침 정비",
    "신고·피해자 보호·조사 절차 설계",
    "법정의무·심화 교육 운영",
    "사건 대응 모니터링 체계 구축",
  ],
  "인사노무 정기 자문(월 고문)": [
    "월간 이슈 진단·우선순위 설정",
    "정기 자문 회의·실행안 제공",
    "긴급 분쟁 이슈 신속 대응",
    "분기 리스크 리포트 및 개선안 제시",
  ],
  "노무 진단 보고서 작성": [
    "진단 범위·평가 지표 확정",
    "문서·인터뷰·현장 데이터 수집",
    "리스크 분석·원인 구조화",
    "개선 로드맵 보고서 제출",
  ],
};

export function buildWorkflowSteps(serviceName: string): string[] {
  const mapped = WORKFLOW_BY_SERVICE[serviceName];
  if (mapped && mapped.length > 0) return mapped;
  return [
    `${serviceName} 관련 사실관계 진단`,
    "핵심 증빙자료 정리",
    "대응 절차 수립 및 실행",
    "결과 안내 및 후속 조치",
  ];
}

function escapeXml(value: string) {
  return value
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&apos;");
}

function fitText(text: string, limit = 28) {
  if (text.length <= limit) return text;
  return `${text.slice(0, limit - 1)}…`;
}

export function buildWorkflowInfographicSvg(serviceName: string, workflowSteps: string[]) {
  const steps = workflowSteps.slice(0, 5);
  const width = 900;
  const top = 96;
  const gap = 22;
  const boxHeight = 66;
  const boxWidth = 740;
  const totalHeight = top + steps.length * (boxHeight + gap) + 50;
  const startX = (width - boxWidth) / 2;

  const blocks = steps
    .map((step, index) => {
      const y = top + index * (boxHeight + gap);
      const stepText = `${index + 1}. ${fitText(step, 48)}`;
      const nextY = y + boxHeight;
      const arrow = index < steps.length - 1
        ? `
    <line x1="${width / 2}" y1="${nextY + 2}" x2="${width / 2}" y2="${nextY + gap - 6}" stroke="#94a3b8" stroke-width="2" />
    <polygon points="${width / 2 - 6},${nextY + gap - 9} ${width / 2 + 6},${nextY + gap - 9} ${width / 2},${nextY + gap}" fill="#94a3b8" />`
        : "";
      return `
    <rect x="${startX}" y="${y}" width="${boxWidth}" height="${boxHeight}" rx="12" fill="#ffffff" stroke="#cbd5e1" />
    <text x="${startX + 24}" y="${y + 40}" font-size="22" fill="#0f172a" font-family="Pretendard, Apple SD Gothic Neo, Segoe UI, sans-serif">${escapeXml(stepText)}</text>${arrow}`;
    })
    .join("\n");

  return `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${totalHeight}" viewBox="0 0 ${width} ${totalHeight}">
  <rect width="100%" height="100%" fill="#f8fafc"/>
  <text x="${width / 2}" y="46" text-anchor="middle" font-size="30" font-weight="700" fill="#0f172a" font-family="Pretendard, Apple SD Gothic Neo, Segoe UI, sans-serif">${escapeXml(
    fitText(`${serviceName} 업무 플로우`, 30)
  )}</text>
  <text x="${width / 2}" y="72" text-anchor="middle" font-size="16" fill="#475569" font-family="Pretendard, Apple SD Gothic Neo, Segoe UI, sans-serif">신청 후 진행 순서 안내</text>
  ${blocks}
</svg>`;
}

export function buildWorkflowInfographicDataUrl(serviceName: string, workflowSteps: string[]) {
  const svg = buildWorkflowInfographicSvg(serviceName, workflowSteps);
  return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
}
