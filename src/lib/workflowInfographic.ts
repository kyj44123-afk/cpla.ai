const WORKFLOW_BY_SERVICE: Record<string, string[]> = {
  "전문 공인노무사 상담": [
    "초기 상담 접수 및 이슈 진단",
    "핵심 쟁점·리스크 구조화",
    "실행 가능한 대응 시나리오 제시",
    "후속 진행(대리·자문) 범위 확정",
  ],
  "임금체불 진정사건 대리": [
    "체불 항목·기간·금액 확정",
    "증빙자료 정리 및 진정 전략 수립",
    "노동청 진정 절차 대리 진행",
    "결정 결과 후속 집행 지원",
  ],
  "대지급금 신청 대리": [
    "수급 요건(도산·지급불능) 사전 진단",
    "필수 증빙·신청서류 구성",
    "대지급금 신청 대리 진행",
    "보완요청 대응 및 결과 안내",
  ],
  "퇴직금 청구 대리": [
    "근속기간·평균임금 산정 검토",
    "퇴직금 미지급 금액 확정",
    "청구 절차(진정/소송 연계) 진행",
    "수령 단계까지 후속 관리",
  ],
  "임금명세서 위반 대응": [
    "명세서 교부 이력 및 누락 항목 확인",
    "위반 유형별 법적 쟁점 정리",
    "시정요구·행정대응 절차 진행",
    "재발 방지 문서체계 정비",
  ],
  "최저임금 위반 대응": [
    "임금구성항목 및 시급 환산 검토",
    "최저임금 미달 구간·금액 산출",
    "시정·청구 절차 진행",
    "정산 및 재발 방지안 정리",
  ],
  "연장·야간·휴일수당 청구": [
    "근로시간 데이터 및 근무기록 확보",
    "가산수당 산정 기준 확정",
    "수당 청구·진정 절차 진행",
    "지급 결과 및 후속 대응",
  ],
  "연차휴가 미사용수당 청구": [
    "연차 발생·사용·소멸 이력 검토",
    "미사용수당 대상 일수·금액 확정",
    "청구 절차 진행 및 대응",
    "지급 완료 후 정산 검토",
  ],
  "근로시간 위반 진단": [
    "근무표·출퇴근기록 수집",
    "법정 근로·휴게 기준 대비 분석",
    "위반 리스크 및 개선안 도출",
    "운영기준 재정비안 제시",
  ],
  "포괄임금제 적법성 점검": [
    "포괄임금 약정·운영 실태 파악",
    "적법성·무효 가능성 검토",
    "임금 재산정 및 분쟁 리스크 분석",
    "개선 계약안·운영안 제시",
  ],
  "통상임금 재산정 자문": [
    "임금항목별 통상임금 포함 여부 검토",
    "재산정 금액·파급효과 분석",
    "분쟁·소급 리스크 대응안 수립",
    "임금체계 보완안 확정",
  ],
  "부당해고 구제신청 대리": [
    "해고 사유·절차 적법성 검토",
    "증빙·주장 구조화 및 서면 준비",
    "노동위원회 구제신청 대리 진행",
    "심문·결정 후속 조치",
  ],
  "부당징계 구제신청 대리": [
    "징계사유·양정·절차 검토",
    "징계 무효 주장 포인트 정리",
    "구제신청·심문 대응 대리",
    "결정 이후 복귀·정산 지원",
  ],
  "부당전직·전보 대응": [
    "발령 사유·업무상 필요성 검토",
    "불이익 여부 및 위법성 판단",
    "이의제기·구제절차 진행",
    "원상회복·조건조정 협의",
  ],
  "권고사직·사직강요 대응": [
    "퇴사 권유 과정 및 증거 확보",
    "자발성·강요성 판단 포인트 정리",
    "대응 전략(유지/합의/구제) 확정",
    "협상·절차 후속 지원",
  ],
  "직장 내 괴롭힘 신고 대응": [
    "사건 타임라인·행위 유형 정리",
    "증거 확보 및 신고 문서 작성",
    "사내 조사·조치 절차 대응",
    "후속 보호조치·외부절차 연계",
  ],
  "직장 내 성희롱 대응": [
    "피해 사실·행위 유형 정리",
    "증거·진술 확보 및 신고 설계",
    "사내 조사·징계 절차 대응",
    "재발방지·추가 구제 절차 연계",
  ],
  "산재보상 신청 대리": [
    "사고·질병 발생 경위 확인",
    "업무관련성 입증자료 구성",
    "산재급여 신청 절차 대리",
    "결정 통지 후 보완·이의 대응",
  ],
  "업무상질병 산재 인정 대응": [
    "질병 진단·업무이력 분석",
    "노출·과로·인과관계 자료 정리",
    "업무상질병 인정 신청 진행",
    "보완요구·불승인 대응",
  ],
  "장해급여 청구 지원": [
    "치료종결 및 장해 상태 확인",
    "장해등급 판단자료 구성",
    "장해급여 청구 진행",
    "등급 결과 이의·보완 대응",
  ],
  "유족급여·장의비 청구 지원": [
    "사망 경위·업무관련성 자료 수집",
    "유족 범위·청구권 검토",
    "유족급여·장의비 청구 진행",
    "결정 이후 후속 권리 안내",
  ],
  "실업급여 이직확인서 대응": [
    "이직 사유·확인서 기재 검토",
    "정정 필요 항목 및 근거 정리",
    "정정 요청·행정 절차 진행",
    "수급 안정화 후속 지원",
  ],
  "부정수급 조사 대응": [
    "조사 통지 내용·쟁점 파악",
    "소명자료 수집·반박 논리 정리",
    "조사·의견진술 절차 대응",
    "환수·제재 후속 대응",
  ],

  "사업주·인사담당 노무자문": [
    "현안 이슈 및 리스크 범위 정의",
    "법적 쟁점·의사결정 옵션 도출",
    "실행 우선순위 및 일정 확정",
    "문서화·내부 커뮤니케이션 지원",
  ],
  "취업규칙 제·개정 자문": [
    "현행 규정·운영 실태 진단",
    "개정안 작성 및 불이익변경 검토",
    "의견수렴·절차 이행 지원",
    "신고·시행 후 운영점검",
  ],
  "근로계약서 점검·작성": [
    "직무·고용형태별 계약요건 정리",
    "계약서 조항 적법성 검토",
    "표준 계약서 템플릿 작성",
    "체결·보관 운영안 정착",
  ],
  "인사규정 정비 자문": [
    "규정 체계·충돌 조항 진단",
    "채용·평가·징계·퇴직 기준 정비",
    "규정 문안 개정·승인 절차 지원",
    "운영 매뉴얼·교육 연계",
  ],
  "임금체계 개편 자문": [
    "현 임금체계 데이터 진단",
    "개편 목표·원칙 설계",
    "직무·성과 기반 구조안 수립",
    "전환 시뮬레이션·시행 로드맵 확정",
  ],
  "성과급·인센티브 설계 자문": [
    "보상 목표·지표 설계",
    "지급기준·평가연동 구조 정의",
    "법적 리스크·분쟁 포인트 점검",
    "운영지침·커뮤니케이션 실행",
  ],
  "인사평가 제도 설계": [
    "평가 목적·직군별 체계 정렬",
    "평가항목·척도·프로세스 설계",
    "공정성·이의절차 장치 반영",
    "시범운영·정식도입 지원",
  ],
  "징계위원회 운영 자문": [
    "사건 접수·조사 범위 확정",
    "징계사유·양정기준 검토",
    "징계위 운영·의결 절차 지원",
    "통지·이의 대응 문서화",
  ],
  "노동청 근로감독 대응": [
    "점검 항목 사전 모의진단",
    "요구자료 패키지 준비",
    "현장감독 대응 및 소명",
    "시정지시 이행·사후관리",
  ],
  "노동관계 법정의무 컴플라이언스 점검": [
    "법정의무 체크리스트 진단",
    "미준수 항목 우선순위 설정",
    "시정계획·책임체계 수립",
    "정기 점검 프로세스 구축",
  ],
  "4대보험 취득·상실 정정 자문": [
    "자격취득·상실 이력 점검",
    "오류 항목·원인 분석",
    "정정 신고·소명 절차 진행",
    "재발 방지 운영기준 수립",
  ],
  "노사협의회 설치·운영 자문": [
    "설치 요건·대표 구성 점검",
    "운영규정·회의체계 설계",
    "의결·협의 안건 운영 지원",
    "회의록·후속 조치 관리",
  ],
  "고충처리제도 구축": [
    "고충 유형·처리 기준 정의",
    "접수·조사·조치 프로세스 설계",
    "담당자 역할·보고체계 수립",
    "운영 모니터링 체계 정착",
  ],
  "단체교섭 전략 자문": [
    "교섭 의제·쟁점 사전 분석",
    "교섭안·양보안 시나리오 수립",
    "교섭 진행·문서 대응 지원",
    "합의안 정리·이행관리",
  ],
  "단체협약 검토 자문": [
    "협약 조항 법적 리스크 진단",
    "운영상 충돌 조항 정비",
    "개정안·협상 포인트 도출",
    "체결 후 시행체계 점검",
  ],
  "노동쟁의 대응 자문": [
    "쟁의 국면 리스크 진단",
    "합법 쟁의 대응 가이드 수립",
    "현장 운영·커뮤니케이션 대응",
    "분쟁 완화·후속 정상화 지원",
  ],
  "부당노동행위 구제신청 지원": [
    "행위 유형·사실관계 정리",
    "증빙자료·주장 구조화",
    "구제신청 절차 진행 지원",
    "판정 이후 후속 조치 대응",
  ],
  "비정규직 차별시정 대응": [
    "차별 요소·비교대상 설정",
    "임금·처우 차이 분석",
    "시정신청·협의 절차 진행",
    "제도 보완 및 재발방지",
  ],
  "파견·도급 적법성 진단": [
    "업무지휘·인력운영 구조 분석",
    "파견/도급 판단 기준 검토",
    "불법파견 리스크 대응안 수립",
    "계약·운영모델 개선 실행",
  ],
  "원·하청 노무리스크 점검": [
    "원·하청 역할·책임 구조 진단",
    "현장 운영 리스크 식별",
    "계약·관리체계 개선안 제시",
    "점검 체계 정례화",
  ],
  "직장폐쇄·쟁의 국면 대응": [
    "쟁의 상황 법적 쟁점 분석",
    "직장폐쇄 요건·절차 검토",
    "현장 운영·대응 시나리오 실행",
    "사후 분쟁 정리 및 복구",
  ],
  "기업 인사노무 실사(DD)": [
    "실사 범위·데이터룸 구성",
    "채용·임금·노사 리스크 분석",
    "핵심 이슈 보고서 작성",
    "거래조건·시정계획 제안",
  ],
  "HR Due Diligence 보고서 작성": [
    "핵심 리스크 항목 프레임 설계",
    "문서·인터뷰 기반 사실확인",
    "리스크 등급화·영향도 분석",
    "개선 권고안 포함 보고서 제출",
  ],
  "사내 교육(노동법·인사실무)": [
    "교육 대상·수준별 니즈 진단",
    "사례 중심 커리큘럼 설계",
    "현장 교육 및 Q&A 진행",
    "사후 매뉴얼·운영 가이드 제공",
  ],
  "직장 내 괴롭힘 예방체계 구축": [
    "예방 규정·기준 수립",
    "신고·조사 프로토콜 설계",
    "관리자·직원 교육 실행",
    "운영 점검 및 개선 루프 구축",
  ],
  "직장 내 성희롱 예방체계 구축": [
    "예방·대응 규정 정비",
    "신고·보호·조사 절차 설계",
    "법정·심화 교육 운영",
    "사건 대응 모니터링 체계 구축",
  ],
  "인사노무 정기 자문(월 고문)": [
    "월간 이슈 진단·우선순위 확정",
    "정기 자문 회의·실행안 제공",
    "긴급 이슈 신속 대응",
    "분기별 리스크 리포트 제공",
  ],
  "노무 진단 보고서 작성": [
    "진단 범위·평가 지표 정의",
    "문서·인터뷰·현장 데이터 수집",
    "리스크 분석·원인 도출",
    "개선 로드맵 보고서 제출",
  ],
};

export function buildWorkflowSteps(serviceName: string): string[] {
  const mapped = WORKFLOW_BY_SERVICE[serviceName];
  if (mapped && mapped.length > 0) return mapped;
  return [
    `${serviceName} 관련 사실관계 진단`,
    "핵심 증빙자료 정리",
    "대응 절차 수립 및 실행",
    "결과 안내 및 후속 조치",
  ];
}

function escapeXml(value: string) {
  return value
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&apos;");
}

function fitText(text: string, limit = 28) {
  if (text.length <= limit) return text;
  return `${text.slice(0, limit - 1)}…`;
}

export function buildWorkflowInfographicSvg(serviceName: string, workflowSteps: string[]) {
  const steps = workflowSteps.slice(0, 5);
  const width = 900;
  const top = 96;
  const gap = 22;
  const boxHeight = 66;
  const boxWidth = 740;
  const totalHeight = top + steps.length * (boxHeight + gap) + 50;
  const startX = (width - boxWidth) / 2;

  const blocks = steps
    .map((step, index) => {
      const y = top + index * (boxHeight + gap);
      const stepText = `${index + 1}. ${fitText(step, 48)}`;
      const nextY = y + boxHeight;
      const arrow = index < steps.length - 1
        ? `
    <line x1="${width / 2}" y1="${nextY + 2}" x2="${width / 2}" y2="${nextY + gap - 6}" stroke="#94a3b8" stroke-width="2" />
    <polygon points="${width / 2 - 6},${nextY + gap - 9} ${width / 2 + 6},${nextY + gap - 9} ${width / 2},${nextY + gap}" fill="#94a3b8" />`
        : "";
      return `
    <rect x="${startX}" y="${y}" width="${boxWidth}" height="${boxHeight}" rx="12" fill="#ffffff" stroke="#cbd5e1" />
    <text x="${startX + 24}" y="${y + 40}" font-size="22" fill="#0f172a" font-family="Pretendard, Apple SD Gothic Neo, Segoe UI, sans-serif">${escapeXml(stepText)}</text>${arrow}`;
    })
    .join("\n");

  return `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${totalHeight}" viewBox="0 0 ${width} ${totalHeight}">
  <rect width="100%" height="100%" fill="#f8fafc"/>
  <text x="${width / 2}" y="46" text-anchor="middle" font-size="30" font-weight="700" fill="#0f172a" font-family="Pretendard, Apple SD Gothic Neo, Segoe UI, sans-serif">${escapeXml(
    fitText(`${serviceName} 업무 플로우`, 30)
  )}</text>
  <text x="${width / 2}" y="72" text-anchor="middle" font-size="16" fill="#475569" font-family="Pretendard, Apple SD Gothic Neo, Segoe UI, sans-serif">신청 후 진행 순서 안내</text>
  ${blocks}
</svg>`;
}

export function buildWorkflowInfographicDataUrl(serviceName: string, workflowSteps: string[]) {
  const svg = buildWorkflowInfographicSvg(serviceName, workflowSteps);
  return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
}
